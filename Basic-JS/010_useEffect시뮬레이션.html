<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>useEffect 클린업 실습</title>
  </head>
  <body>
    <h1>상품 데이터 로딩 시뮬레이션</h1>
    <p id="status">상태: 초기화 중...</p>
    <button id="unmountBtn">컴포넌트 제거 시뮬레이션</button>

    <script>
      const $status = document.getElementById("status");
      const $unmountBtn = document.getElementById("unmountBtn");

      // ===============================================
      // 1. 비동기 데이터 페칭 함수 시뮬레이션
      // ===============================================
      const fetchProducts = () => {
        return new Promise((resolve, reject) => {
          // 2초 후 성공(resolve) 시뮬레이션
          setTimeout(() => {
            const products = [
              { id: 1, name: "청바지" },
              { id: 2, name: "후드티" },
            ];
            resolve(products);
            // 실패 시뮬레이션을 원하면 reject("API 서버 오류")를 호출해 보세요.
          }, 2000);
        });
      };

      // ===============================================
      // 2. useEffect 시뮬레이션 함수 (React 컴포넌트 내부 역할)
      // ===============================================
      let isComponentMounted = true; // 컴포넌트 마운트 상태 시뮬레이션 변수

      function useFetchProducts() {
        // [A] : 데이터 로딩 시작을 표시
        $status.textContent = "상태: 상품 데이터 로딩 중...";

        // ----------------------------------------------------
        // 💡 useEffect 콜백 시뮬레이션 시작
        // ----------------------------------------------------

        let isCancelled = false; // 👈 클린업 함수에서 이 값을 'true'로 바꿀 예정!

        fetchProducts()
          .then((data) => {
            // [B] : 데이터 수신 후 상태 업데이트
            // ⚠️ 여기서 isCancelled 값을 체크해야 합니다!

            if (!isCancelled) {
              // 👈 이 조건문을 완성하세요!
              $status.textContent = `✅ 성공: ${data.length}개 상품 로드 완료!`;
              console.log("데이터 상태 업데이트 완료.");
            } else {
              console.log("❌ 취소됨: 컴포넌트가 사라져 업데이트를 건너뜀.");
            }
          })
          .catch((error) => {
            if (!isCancelled) {
              // 실패 시에도 체크는 중요!
              $status.textContent = `❌ 오류: ${error}`;
            }
          });

        // ----------------------------------------------------
        // 💡 클린업 함수 시뮬레이션 반환 (다음 실행 또는 언마운트 시 호출됨)
        // ----------------------------------------------------
        return () => {
          // [C] : 이 클린업 함수가 실행되면 isCancelled 값을 true로 설정하여
          // 위 .then() 내부의 상태 업데이트를 막아야 합니다.
          isCancelled = true;
          console.log("🧹 클린업 실행: 비동기 업데이트 방지 준비 완료.");
        };
      }

      // ===============================================
      // 3. 테스트 실행 및 언마운트 시뮬레이션
      // ===============================================

      // 컴포넌트 마운트 시 (첫 렌더링 시) useEffect 실행 시뮬레이션
      const cleanupFunction = useFetchProducts();

      $unmountBtn.addEventListener("click", () => {
        if (isComponentMounted) {
          // 언마운트 시: 클린업 함수를 호출
          cleanupFunction();
          isComponentMounted = false;
          $status.textContent = "컴포넌트 제거됨. 2초 후 업데이트되는지 확인!";
        }
      });
    </script>
  </body>
</html>
